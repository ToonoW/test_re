FROM 172.31.4.157:5000/gizwits2015/gizwits-python:latest

MAINTAINER Jam Huang <jamhuang@gizwits.com>

RUN virtualenv /env-gw_reapi
RUN mkdir -p /gw_reapi
WORKDIR /gw_reapi
ADD deploy/requirement.txt.docker requirements.txt
#RUN /env-gw_reapi/bin/pip install -i http://172.32.1.187:3141/root/gizwits -r requirements.txt
RUN /env-gw_reapi/bin/pip install -r requirements.txt

ADD . /gw_reapi
ADD nginx.conf /etc/nginx/nginx.conf
ADD gw_reapi.conf /etc/nginx/sites-available/gw_reapi
RUN ln -s /etc/nginx/sites-available/gw_reapi /etc/nginx/sites-enabled/
RUN rm -f /etc/nginx/sites-enabled/default
RUN mkdir -p /data/nginx
RUN mkdir -p /data/supervisor

VOLUME /data/nginx
VOLUME /data/supervisor

ENV DEBIAN_FRONTEND noninteractive

RUN apt-get update && apt-get install -y git npm nodejs openjdk-7-jre
RUN ln -s /usr/bin/nodejs /usr/local/bin/node

RUN mkdir -p /webroot
ADD doc/ /webroot

RUN mkdir -p /swagger-ui
WORKDIR /swagger-ui
ADD swagger-ui/package.json    /swagger-ui/package.json
RUN npm config set registry https://registry.npm.taobao.org
RUN npm config set strict-ssl false
RUN npm install
ADD swagger-ui/   /swagger-ui
RUN npm install gulp
WORKDIR /gw_reapi

EXPOSE 80

ENTRYPOINT ["/usr/bin/supervisord"]
CMD ["-n"]
